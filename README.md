# dbsync

Инструмент для синхронизации схем и данных между двумя базами данных PostgreSQL (например, тестовой и продуктовой). Он позволяет выявлять различия в схемах, интерактивно применять изменения (создание таблиц/колонок, удаление колонок/таблиц) и синхронизировать данные на основе выбранного ключа синхронизации.

## Требования

- Python 3.11+
- PostgreSQL 16+
- Docker / Docker Compose (для локальной разработки и тестирования)

## Установка и Запуск

1.  **Настройка переменных окружения**:
    Скопируйте файл `.env.example` в `.env` и заполните переменные `TEST_DB_DSN` и `PROD_DB_DSN` соответствующими строками подключения к вашим базам данных PostgreSQL. Также можно настроить `LOG_LEVEL` (по умолчанию `INFO`).
    В .env.example уже прописаны те же БД, что и в `docker-compose.test.yml`.

    ```bash
    cp .env.example .env
    # Отредактируйте .env
    ```

2.  **Запуск баз данных через Docker Compose (опционально, для локальной разработки)**:
    Проект включает файл `docker-compose.test.yml` для быстрого развертывания тестовой и продуктовой баз данных PostgreSQL.

    ```bash
    docker compose -f docker-compose.test.yml up -d
    ```

3.  **Установка зависимостей**:
    Установите проект в редактируемом режиме:

    ```bash
    pip install -e .
    ```

## Использование

### Заполнение тестовых данных

Для быстрого заполнения тестовой и продуктовой баз данных предопределенными данными используйте скрипт `seed_db.py`:

```bash
python scripts/seed_db.py
```

Этот скрипт создает различные схемы таблиц и вставляет примеры данных, демонстрируя сценарии расхождений между базами.

### Синхронизация схемы и данных

Запустите основной модуль `dbsync` для сравнения схем и синхронизации данных:

```bash
python -m dbsync
```

Инструмент выполнит следующие шаги:
1.  Сравнит схемы тестовой и продуктовой баз данных.
2.  Предложит создать отсутствующие таблицы и колонки в продуктовой базе.
3.  Интерактивно запросит подтверждение на удаление "лишних" колонок или таблиц в продуктовой базе, которых нет в тестовой.
4.  Для каждой общей таблицы предложит выбрать столбец (или комбинацию столбцов) для синхронизации данных (ключ синхронизации).
5.  Вставит новые строки из тестовой базы в продуктовую и обновит существующие строки на основе выбранного ключа синхронизации.
6.  В случае конфликтов `NOT NULL` ограничений при вставке данных, инструмент интерактивно предложит удалить ограничение или применить значение по умолчанию.


### Просмотр состояния баз данных

Для удобного просмотра содержимого таблиц в тестовой и продуктовой базах данных используйте скрипт `show_db.py`:

```bash
python scripts/show_db.py
```

Скрипт выводит таблицы в форматированном виде с помощью библиотеки `rich`.

## Тестирование

Запустите тесты с помощью `pytest`:

```bash
python -m pytest
```